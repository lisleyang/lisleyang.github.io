<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>关于Promise我的理解 | 海洋Lisle</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">关于Promise我的理解</h1><a id="logo" href="/.">海洋Lisle</a><p class="description">大道至简，知易行难</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">关于Promise我的理解</h1><div class="post-meta">Aug 15, 2018</div><div class="post-content"><p>网上关于Promise的文章非常之多，但我觉得Promise的难点不在语法上，而是在链式调用和错误处理部分。本文将主要就这两部分进行展开说明。</p>
<h2 id="1-Promise的典型应用"><a href="#1-Promise的典型应用" class="headerlink" title="1. Promise的典型应用"></a>1. Promise的典型应用</h2><p>Promise的提出，解决了异步函数回调地狱的问题，也更加符合开放封闭原则；</p>
<p>示例一：</p>
<p>原始写法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">image.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      cb_success()</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cb_success</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'success'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Promise形式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImg</span>(<span class="params">src</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> pr = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">      img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        resolve(img)</span><br><span class="line">      &#125;</span><br><span class="line">      img.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        reject(<span class="string">'加载失败'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      img.src = src;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pr = loadImg(<span class="string">'https://www.baidu.com/img/superlogo_c4d7df0a003d3db9b65e9ef0fe6da1ec.png?where=super'</span>);</span><br><span class="line"></span><br><span class="line">pr.then(<span class="function">(<span class="params">img</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(img.width)</span><br><span class="line">  <span class="keyword">return</span> img  <span class="comment">//注意这儿必须return img，后面的then才能访问到</span></span><br><span class="line">&#125;).then(<span class="function">(<span class="params">img</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(img.height)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>示例二：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(fileA, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">  fs.readFile(fileB, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Promise形式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">'./index.html'</span>,(err,data)=&gt;&#123;</span><br><span class="line">        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意 这儿return的不是具体的内容 而是一个Promise</span></span><br><span class="line">    <span class="comment">//具体的内容是通过resolve返回的 但是能在下一个then里面直接拿到</span></span><br><span class="line">    <span class="comment">//因为Promise内部做了处理，如果返回值是Promise，则直接返回其resolve/reject的内容</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'./page.html'</span>,(err,data)=&gt;&#123;</span><br><span class="line">            resolve(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)  <span class="comment">//resolve的data</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="2-Promise异常捕获"><a href="#2-Promise异常捕获" class="headerlink" title="2. Promise异常捕获"></a>2. Promise异常捕获</h2><h4 id="1-不止在reject的时候会进入catch。前面语法有报错，同样会自动进入catch进行捕获。"><a href="#1-不止在reject的时候会进入catch。前面语法有报错，同样会自动进入catch进行捕获。" class="headerlink" title="@1. 不止在reject的时候会进入catch。前面语法有报错，同样会自动进入catch进行捕获。"></a>@1. 不止在reject的时候会进入catch。前面语法有报错，同样会自动进入catch进行捕获。</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//f11s变量不存在，代码报错</span></span><br><span class="line">    f11s.readFile(<span class="string">'./index.html'</span>,(err,data)=&gt;&#123; </span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            reject(err)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)  <span class="comment">//  直接进catch</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">'./in123dex.html'</span>,(err,data)=&gt;&#123; <span class="comment">//这个文件不存在</span></span><br><span class="line">        <span class="comment">////这个时候进入回调函数的这部分</span></span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            <span class="comment">//手动抛出异常也可以进入catch</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)  <span class="comment">//前面throw new Error,所以直接进catch</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="2-then里面写两个回调的写法在链式调用时，catch捕获异常容易出问题；所以一般在链式调用时推荐在最后写一次。"><a href="#2-then里面写两个回调的写法在链式调用时，catch捕获异常容易出问题；所以一般在链式调用时推荐在最后写一次。" class="headerlink" title="@2 then里面写两个回调的写法在链式调用时，catch捕获异常容易出问题；所以一般在链式调用时推荐在最后写一次。"></a>@2 then里面写两个回调的写法在链式调用时，catch捕获异常容易出问题；所以一般在链式调用时推荐在最后写一次。</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> pr = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">  reject(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pr.then(</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'success 1'</span>),</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'error 1'</span>)</span><br><span class="line">)</span><br><span class="line">pr.then(</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'success 2'</span>),</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'error 2'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印 error1 error2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> pr = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">  reject(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pr.then(</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'success 1'</span>),</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'error 1'</span>)</span><br><span class="line">).then(</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'success 2'</span>),</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'error 2'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印 error1 success2</span></span><br></pre></td></tr></table></figure>
<p>所以推荐写法：统一进行错误捕捉</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//链式调用</span></span><br><span class="line"><span class="keyword">let</span> pr1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">  reject(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pr1.then(</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'success 1'</span>)</span><br><span class="line">).then(</span><br><span class="line">  ()=&gt;<span class="built_in">console</span>.log(<span class="string">'success 2'</span>)</span><br><span class="line">).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="3-Promise链式调用"><a href="#3-Promise链式调用" class="headerlink" title="3. Promise链式调用"></a>3. Promise链式调用</h3><p>then函数必须返回Promise的实例。</p>
<p>首先，下面这段代码是可以执行的，因为<strong>then方法默认返回一个Promise</strong>,Promise就有then方法。想要传递参数需要return；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">'li'</span>)</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value)  <span class="comment">//li</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'hello '</span> + value;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(val)  <span class="comment">//hello val</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>但Promise规范规定 <code>then回调函数return的应该是一个Promise</code>，所以可以这么写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">'li'</span>)</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value)  <span class="comment">//li</span></span><br><span class="line">  <span class="keyword">return</span>  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">    resolve(<span class="string">'hello '</span> + value);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(val)  <span class="comment">//hello val</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>正常使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">'./index.html'</span>,(err,data)=&gt;&#123;</span><br><span class="line">        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意 这儿return的不是具体的内容 而是一个Promise</span></span><br><span class="line">    <span class="comment">//具体的内容是通过resolve返回的 但是能在下一个then里面直接拿到</span></span><br><span class="line">    <span class="comment">//因为Promise内部做了处理，如果返回值是Promise，则直接返回其resolve/reject的内容</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'./page.html'</span>,(err,data)=&gt;&#123;</span><br><span class="line">            resolve(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)  <span class="comment">//resolve的data</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="4-Promise-all"><a href="#4-Promise-all" class="headerlink" title="4. Promise.all**"></a>4. Promise.all**</h4><p>Promise.all的返回值默认是一个数组。在参数里的全部promise运行完成后执行。</p>
<p>如下是工作中的一个需求，需要先从前面两个接口中获取通行证id，再根据这两个id从第三个接口中取聊天记录；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p1 = getData(&#123;</span><br><span class="line">        url: <span class="string">'url1'</span>,</span><br><span class="line">        method: <span class="string">'get'</span>,</span><br><span class="line">        params: &#123;</span><br><span class="line">            passportid: info.agentPassportID</span><br><span class="line">        &#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> res)</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> alert(<span class="string">'获取agentID失败'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p2 = getData(&#123;</span><br><span class="line">    url: <span class="string">'url2'</span>,</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    params: &#123;</span><br><span class="line">        passportid: info.customerPassportID</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> res)</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> alert(<span class="string">'获取customerID失败'</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([p1, p2])</span><br><span class="line">.then(<span class="function"><span class="params">result</span> =&gt;</span> &#123; <span class="comment">//result是个数组，里面是各个Promise 的resolve结果</span></span><br><span class="line">    <span class="keyword">return</span> getData(&#123;</span><br><span class="line">        url: <span class="string">'url3'</span>,</span><br><span class="line">        method: <span class="string">'get'</span>,</span><br><span class="line">        params: &#123;</span><br><span class="line">            command: <span class="string">'getMessage'</span>,</span><br><span class="line">            <span class="keyword">from</span>: result[<span class="number">0</span>].data.Data,</span><br><span class="line">            sendto: result[<span class="number">1</span>].data.Data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> alert(<span class="string">'获取聊天记录失败'</span>));</span><br></pre></td></tr></table></figure>
<h3 id="5-Promise-race"><a href="#5-Promise-race" class="headerlink" title="5. Promise.race**"></a>5. Promise.race**</h3><p>与Promise.all相同，区别是只要有一个完成就算完成。</p>
<p>常见用法:</p>
<ul>
<li>把异步操作和定时器放在一起</li>
<li>如果定时器先触发，就认定超时,告知用户</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'this is p1'</span>)</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    resolve(<span class="string">'aaa'</span>)</span><br><span class="line">  &#125;,<span class="number">5000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'this is p2'</span>)</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    resolve(<span class="string">'bbb'</span>)</span><br><span class="line">  &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.race([p1,p2]).then(<span class="function"><span class="params">val</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val)  <span class="comment">//bbb</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="6-在IE中使用Promise"><a href="#6-在IE中使用Promise" class="headerlink" title="6. 在IE中使用Promise**"></a>6. 在IE中使用Promise**</h3><p>IE8,9,10,11均不原生支持Promise；IE Edge支持</p>
<p>解决方案： BlueBird/Promise Polyfill</p>
</div><div class="tags"><a href="/tags/es6/">es6</a></div><div class="post-nav"><a class="pre" href="/2018/08/16/如何利用Charles进行抓包/">如何利用Charles进行抓包</a><a class="next" href="/2017/10/26/兼容低版本浏览器情况下的前端功能化方案探究/">兼容低版本浏览器情况下的前端工程化化方案探究</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/前端架构/" style="font-size: 15px;">前端架构</a> <a href="/tags/开发工具/" style="font-size: 15px;">开发工具</a> <a href="/tags/性能优化/" style="font-size: 15px;">性能优化</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/14/关于Typescript-jQuery声明文件的主要结构/">关于Typescript:jQuery声明文件的主要结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/14/typescript的接口（interface）/">typescript的接口（interface）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/21/几句话讲清楚节流和防抖/">几句话讲清楚节流和防抖</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/20/几句话讲清楚javascript原型/">几句话讲清楚javascript原型</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/20/几句话讲清楚缓存/">几句话讲清楚浏览器缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/如何使用eslint/">如何使用eslint</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/17/在命令行中打开vscode和sublime/">在命令行中打开vscode和sublime</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/01/Shell编程/">Shell学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/21/learning Typescript中文版学习笔记/">《learning Typescript中文版》学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/16/如何利用Charles进行抓包/">如何利用Charles进行抓包</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 链接</i></div><ul></ul><a href="https://github.com/lisleyang" title="我的github" target="_blank">我的github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">海洋Lisle.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>